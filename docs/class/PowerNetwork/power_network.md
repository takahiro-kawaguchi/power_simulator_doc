# power_network クラス

このクラスを継承したクラスを作ることで，様々なネットワークに対応したシステムを作成することができる．

## 変数

- **bus**   
  ネットワーク中のバスを格納したセル配列．バスはbus classのインスタンス．
- **branch**  
   ブランチのパラメータを格納したテーブル．  
    デフォルトのget_admittance_matrixメソッドでは，次の変数を参照している．  
    bus_from, bus_to, y, x_real, x_imag, tap, phase

- **omega0**  
  系統の基本周波数(rad/sec)．60Hzなら，`60*2*pi`
- **x_ss**  
  潮流計算で得られた平衡点における状態変数
- **V_ss**  
  潮流計算で得られた平衡点におけるバス電圧．  
  複素電圧の実部と虚部が並んでいる(Real(V1), Imag(V1), Real(V2), Imag(V2), ... )
- **I_ss**  
  潮流計算で得られた平衡点におけるバス電流．複素電流の実部と虚部が並んでいる．
- **controllers**  
  接続されたレトロフィットコントローラを格納した配列．  
  それぞれの要素はcontrollerクラスのインスタンス．  
  シミュレーション時にグローバルコントローラが生成する入力信号が渡される．
- **controllers_global**  
  接続されたグローバルコントローラを格納した配列．  
  それぞれの要素はcontrollerクラスのインスタンス．  
  シミュレーション時には他のコントローラが生成した入力信号は一切渡されない．


## メソッド

- **initialize()**  
  初期化処理

- **[Y, Ymat] = get_admittance_matrix(idx)**  
  アドミタンス行列の作成．Yは複素数，YmatはYの実部と虚部を適切に並べた行列．  
  idxで与えたバスからなる部分ネットワークのアドミタンス行列を返す．  
  idxを指定しない場合はネットワーク全体に対するアドミタンス行列を返す．  

- **calculate_power_flow()**  
  潮流計算を行う

- **simulate**  
  out = net.simulate(t, u, idx_u, options) は，optionsで指定された条件で，外部入力uに対するネットワークの応答を計算する．入力uが印加されるバスをidx_uで指定する．  
  tはuと同じ長さのベクトル．入力uはゼロ次ホールドされる．  

  out = net.simulate(t, options)は，optionsで指定された条件で，外部入力なしの応答を計算する．  
  tはシミュレーション開始時刻と終了時刻を指定する．    

  - out は つぎのフィールドをもつ構造体
    - t: 時刻
    - X: バスごとの状態を格納したセル配列
    - V: バスごとの電圧を格納したセル配列
    - Xk: レトロフィットコントローラの状態（コントローラごとのセル配列）
    - Xk_global: グローバルコントローラの状態（コントローラごとのセル配列）
    - U: レトロフィットコントローラが生成した入力（コントローラごとのセル配列）
    - U_global: グローバルコントローラが生成した入力（コントローラごとのセル配列）
    - signals: コントローラが定義した信号を格納した構造体（コントローラごとのセル配列）
    - sol: ode15sが返す解sol
  - optionsはつぎのフィールドをもつ構造体．存在しないフィールドは規定値が使用される．
    - x_init: 状態の初期値．バスごとのセル配列あるいは，すべてをスタックしたベクトル
      （規定値: x_ss）．out.Xを入れると，outの最後の状態からスタートする
    - V_init: 電圧の初期値．バスごとのセル配列あるいは，すべてをスタックしたベクトル
      （規定値: x_init に対応した値）
    - xk_init: レトロフィットコントローラの状態の初期値．
      コントローラごとのセル配列，あるいは，すべてをスタックしたベクトル（規定値: 0)
      out.Xkを入れると，outの最後の状態からスタートする
    - xkg_init: グローバルコントローラの状態の初期値．
      コントローラごとのセル配列，あるいは，すべてをスタックしたベクトル（規定値: 0)
      out.Xk_globalを入れると，outの最後の状態からスタートする
    - fault: 地絡の条件．`{[tstart, tend], idx_fault}`というセル配列のセル配列．
- **simulate_linear**   
  各コンポーネントを線形化した場合のシミュレーションを行う．使い方はsimulateと同様

- **add_controller(controller)**   
  レトロフィットコントローラを追加．controllerはcontrollerクラスのインスタンス  
  ひとつのバスに複数のレトロフィットコントローラを付加した場合，最後に付加したコントローラが使用される（内部でremove_controller(controller.idx)が呼ばれる）

- **add_controller_global(controller)**   
  グローバルコントローラを追加．controllerはcontrollerクラスのインスタンス  
  ひとつのバスに複数のグローバルコントローラが付加できる

- **remove_controller(idx_remove)**  
  idxにidx_removeが含まれるcontrollerを削除する．（controller_globalは削除されない）  

- **sys = get_sys(with_controller)**  
  線形化した状態空間モデルを返す．  
  with_controller=true のとき，コントローラが付加されたシステム，falseならばコントローラなしのシステムを返す．規定値はfalse

- **out = sol2signals(sol, t)**  
  ode15sの解solからsimulateの出力outを作成する．  
  tを指定すると，その時刻に対応した信号が作成される．tを省略すると，solに含まれる時刻が使用される．